# calculateDeviance.R; Patrick G. Meirmans (2013) Non-convergence in Bayesian estimation of migration rates, Molecular Ecology Resources; Supplementary Material

# This script will calculate the Bayesian Deviance from the output of BayesAss (Wilson & Rannala 2003)
# For more information on the use of the deviance, see Faubet et al. (2007)

# To use this script, run BayesAss version 3 with the -t flag to produce a trace-file
# Then set the working directory of R to the folder with the output from BayesAss

## Calculting bayesian deviance and visualizing convergence
```{r}
## Run 1
# Change this value to the actual burnin used for your MCMC run
burnin1 <- 1000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval1 <- 100 
# Read the data from the trace file
trace1 <- read.table("BA3trace1.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace1$State,trace1$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin1, col="grey70", lty=2)
# Calculate the deviance
range1 <- (trace1$State > burnin1 & trace1$State %% sampling.interval1 == 0)
Dev1 <- -2*mean(trace1$LogProb[range1])
# Print the result to the console
print(Dev1)

## Run 2
# Change this value to the actual burnin used for your MCMC run
burnin2 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sample.interval2 <- 100 
# Read the data from the trace file
trace2 <- read.table("BA3trace2.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace2$State,trace2$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin2, col="grey70", lty=2)
# Calculate the deviance
range2 <- (trace2$State > burnin2 & trace2$State %% sample.interval2 == 0)
Dev2 <- -2*mean(trace2$LogProb[range2])
# Print the result to the console
print(Dev2)

## Run 3
# Change this value to the actual burnin used for your MCMC run
burnin3 <- 1000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval3 <- 2000
# Read the data from the trace file
trace3 <- read.table("BA3trace3.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace3$State,trace3$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin3, col="grey70", lty=2)
# Calculate the deviance
range3 <- (trace3$State > burnin3 & trace3$State %% sampling.interval3 == 0)
Dev3 <- -2*mean(trace3$LogProb[range3])
# Print the result to the console
print(Dev3)

## Run 4
# Change this value to the actual burnin used for your MCMC run
burnin4 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval4 <- 100
# Read the data from the trace file
trace4 <- read.table("BA3trace4.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace4$State,trace4$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin4, col="grey70", lty=2)
# Calculate the deviance
range4 <- (trace4$State > burnin4 & trace4$State %% sampling.interval4 == 0)
Dev4 <- -2*mean(trace4$LogProb[range4])
# Print the result to the console
print(Dev4)

## Run 5
# Change this value to the actual burnin used for your MCMC run
burnin5 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval5 <- 100
# Read the data from the trace file
trace5 <- read.table("BA3trace5.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace5$State,trace5$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin5, col="grey70", lty=2)
# Calculate the deviance
range5 <- (trace5$State > burnin5 & trace5$State %% sampling.interval5 == 0)
Dev5 <- -2*mean(trace5$LogProb[range5])
# Print the result to the console
print(Dev5)

## Run 6
# Change this value to the actual burnin used for your MCMC run
burnin6 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval6 <- 100
# Read the data from the trace file
trace6 <- read.table("BA3trace6.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace6$State,trace6$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin6, col="grey70", lty=2)
# Calculate the deviance
range6 <- (trace6$State > burnin6 & trace6$State %% sampling.interval6 == 0)
Dev6 <- -2*mean(trace6$LogProb[range6])
# Print the result to the console
print(Dev6)

## Run 7
# Change this value to the actual burnin used for your MCMC run
burnin7 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval7 <- 100
# Read the data from the trace file
trace7 <- read.table("BA3trace7.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace7$State,trace7$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin7, col="grey70", lty=2)
# Calculate the deviance
range7 <- (trace7$State > burnin7 & trace7$State %% sampling.interval7 == 0)
Dev7 <- -2*mean(trace7$LogProb[range7])
# Print the result to the console
print(Dev7)

## Run 8
# Change this value to the actual burnin used for your MCMC run
burnin8 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval8 <- 100
# Read the data from the trace file
trace8 <- read.table("BA3trace8.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace8$State,trace8$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin8, col="grey70", lty=2)
# Calculate the deviance
range8 <- (trace8$State > burnin8 & trace8$State %% sampling.interval8 == 0)
Dev8 <- -2*mean(trace8$LogProb[range8])
# Print the result to the console
print(Dev8)

## Run 9
# Change this value to the actual burnin used for your MCMC run
burnin9 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval9 <- 100
# Read the data from the trace file
trace9 <- read.table("BA3trace9.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace9$State,trace9$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin9, col="grey70", lty=2)
# Calculate the deviance
range9 <- (trace9$State > burnin9 & trace9$State %% sampling.interval9 == 0)
Dev9 <- -2*mean(trace9$LogProb[range9])
# Print the result to the console
print(Dev9)

## Run 10
# Change this value to the actual burnin used for your MCMC run
burnin10 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval10 <- 100
# Read the data from the trace file
trace10 <- read.table("BA3trace10.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace10$State,trace10$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin10, col="grey70", lty=2)
# Calculate the deviance
range10 <- (trace10$State > burnin10 & trace10$State %% sampling.interval10 == 0)
Dev10 <- -2*mean(trace10$LogProb[range10])
# Print the result to the console
print(Dev10)

## Run 11
# Change this value to the actual burnin used for your MCMC run
burnin11 <- 10000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval11 <- 200
# Read the data from the trace file
trace11 <- read.table("BA3trace11.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace11$State,trace11$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin11, col="grey70", lty=2)
# Calculate the deviance
range11 <- (trace11$State > burnin11 & trace11$State %% sampling.interval11 == 0)
Dev11 <- -2*mean(trace11$LogProb[range11])
# Print the result to the console
print(Dev11)

## Run 12
# Change this value to the actual burnin used for your MCMC run
burnin12 <- 10000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval12 <- 200
# Read the data from the trace file
trace12 <- read.table("BA3trace12.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace12$State,trace12$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin12, col="grey70", lty=2)
# Calculate the deviance
range12 <- (trace12$State > burnin12 & trace12$State %% sampling.interval12 == 0)
Dev12 <- -2*mean(trace12$LogProb[range12])
# Print the result to the console
print(Dev12)

## Run 13
# Change this value to the actual burnin used for your MCMC run
burnin13 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval13 <- 100
# Read the data from the trace file
trace13 <- read.table("BA3trace13.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace13$State,trace13$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin13, col="grey70", lty=2)
# Calculate the deviance
range13 <- (trace13$State > burnin13 & trace13$State %% sampling.interval13 == 0)
Dev13 <- -2*mean(trace13$LogProb[range13])
# Print the result to the console
print(Dev13)

## Run 14
# Change this value to the actual burnin used for your MCMC run
burnin14 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval14 <- 100
# Read the data from the trace file
trace14 <- read.table("BA3trace14.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace14$State,trace14$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin14, col="grey70", lty=2)
# Calculate the deviance
range14 <- (trace14$State > burnin14 & trace14$State %% sampling.interval14 == 0)
Dev14 <- -2*mean(trace14$LogProb[range14])
# Print the result to the console
print(Dev14)

## Run 15
# Change this value to the actual burnin used for your MCMC run
burnin15 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval15 <- 100
# Read the data from the trace file
trace15 <- read.table("BA3trace15.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace15$State,trace15$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin15, col="grey70", lty=2)
# Calculate the deviance
range15 <- (trace15$State > burnin15 & trace15$State %% sampling.interval15 == 0)
Dev15 <- -2*mean(trace15$LogProb[range15])
# Print the result to the console
print(Dev15)

## Run 16
# Change this value to the actual burnin used for your MCMC run
burnin16 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval16 <- 100
# Read the data from the trace file
trace16 <- read.table("BA3trace16.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace16$State,trace16$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin16, col="grey70", lty=2)
# Calculate the deviance
range16 <- (trace16$State > burnin16 & trace16$State %% sampling.interval16 == 0)
Dev16 <- -2*mean(trace16$LogProb[range16])
# Print the result to the console
print(Dev16)

## Run 17
# Change this value to the actual burnin used for your MCMC run
burnin17 <- 5000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval17 <- 100
# Read the data from the trace file
trace17 <- read.table("BA3trace17.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace17$State,trace17$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin17, col="grey70", lty=2)
# Calculate the deviance
range17 <- (trace17$State > burnin17 & trace17$State %% sampling.interval17 == 0)
Dev17 <- -2*mean(trace17$LogProb[range17])
# Print the result to the console
print(Dev17)

## Run 18
# Change this value to the actual burnin used for your MCMC run
burnin18 <- 20000000 
# Change this value to the actual sampling interval used for your MCMC run
sampling.interval18 <- 100
# Read the data from the trace file
trace18 <- read.table("BA3trace18.txt", header=TRUE) 
# Plotting the likelihoods is always a good idea
plot(trace18$State,trace18$LogProb, xlab="State", ylab="LogProb", type="l", lwd=2, col="firebrick3", font.lab=2)
# Draw a vertical line to indicate the end of the burnin
abline(v=burnin18, col="grey70", lty=2)
# Calculate the deviance
range18 <- (trace18$State > burnin18 & trace18$State %% sampling.interval18 == 0)
Dev18 <- -2*mean(trace18$LogProb[range18])
# Print the result to the console
print(Dev18)
```


## Visualizing transition plots of migration
```{r}
# Load required packages
if (!require("Gmisc")) install.packages("Gmisc")
library(Gmisc)
if (!require("DiagrammeR")) install.packages("DiagrammeR")
library(DiagrammeR)

# Load matrix
trans2 <- read.table("example_matrixrun2.csv", sep = ",", header = T, row.names = (1))
e <- read.table("example_matrixrun2_withzs.csv", sep = ",", header = T, row.names = (1))

transmatrix2 <- data.matrix(trans2, rownames.force = NA)
ematrix <- data.matrix(e, rownames.force = NA)

transitionPlot(transmatrix2)
transitionPlot(ematrix)

#################################
a_graph <-
  create_graph() %>%
  add_node() %>%
  add_node() %>%
  add_edge(
    from = 1,
    to = 2)
render_graph(a_graph, layout = "kk")

graph <-
  open_graph(
    system.file(
      "extdata/example_graphs_dgr/repository.dgr",
      package = "DiagrammeR"))
render_graph(graph, layout = "kk")
```

